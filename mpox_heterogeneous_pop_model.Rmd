---
title: "Model 2"
author: "Mpox modellers"
date: "2024-10-11"
output: html_document
editor_options: 
  chunk_output_type: console
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```


# Load the necessary libraries

```{r}

library(deSolve)
library(ggplot2)
library(reshape2)
library(MASS)

```




# First load csv file


```{r}
cases<-read.csv("C:/Users/BENJAMIN TOMMY BAVUG/Documents/DRC_Mpox_Modelling-master/mpox_2024.csv")
observed_data<-cases$new_cases #Extract the weekly case counts

```





```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.25,     # Transmission rate via child to child
  beta_ac = 0.35,         # Transmission rate via adult to child
  gamma_c = 0.12,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.3,                # Detection rate
  gamma_c_Id = 0.2,             # Recovery rate for those who were detected
  rho_c_I = 0.1,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.09,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = (0.25 * 2),     # Transmission rate via adult to adult
  beta_ca = 0.25,         # Transmission rate via child to adult 
  gamma_a = 0.12,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.3,                # Detection rate
  gamma_a_Id = 0.2,             # Recovery rate for those who were detected
  rho_a_I = 0.1,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.09               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 105e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e3,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Children population
    dS_c <- -beta_cc * S_c * I_cc / N_c - beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- beta_cc * S_c * I_cc / N_c - gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    dI_ac <- beta_ac * S_c * I_ac / (N_c + N_a) - gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -beta_aa * S_a * I_aa / N_a - beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- beta_aa * S_a * I_aa / N_a - gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    dI_ca <- beta_ca * S_a * I_ca / (N_c + N_a) - gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}

# Run the simulation with the correct model function
simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = base_params)

# Convert the output to a data frame for analysis and plotting
output <- as.data.frame(simulation)

# Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

# Display the output
print(output)

# Plot the results
library(ggplot2)
ggplot(data = output, aes(x = time)) +
  geom_line(aes(y = Susceptible_children, color = "Susceptible_children"), size = 1) +
  geom_line(aes(y = Infectious_children_via_child_child_pathway, 
                color = "Infectious_children_via_child_child_pathway"), size = 1) +
  geom_line(aes(y = Infectious_children_via_adult_child_pathway, 
                color = "Infectious_children_via_adult_child_pathway"), size = 1) +
  geom_line(aes(y = Detected_children, color = "Detected_children"), size = 1) +
  geom_line(aes(y = Recovered_children, color = "Recovered_children"), size = 1) +
  geom_line(aes(y = Dead_children, color = "Dead_children"), size = 1) +
  
  
  geom_line(aes(y = Susceptible_adult, color = "Susceptible_adult"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_adult_adult_pathway, 
                color = "Infectious_adult_via_adult_adult_pathway"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_child_adult_pathway, 
                color = "Infectious_adult_via_child_adult_pathway"), size = 1) +
  geom_line(aes(y = Detected_adult, color = "Detected_adult"), size = 1) +
  geom_line(aes(y = Recovered_adult, color = "Recovered_adult"), size = 1) +
  geom_line(aes(y = Dead_adult, color = "Dead_adult"), size = 1) +
  
  
  labs(title = "SIRD Model Simulation", x = "Time (weeks)", y = "Population") +
  scale_color_manual("", 
                     breaks = c("Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult"),
                     values = c("blue", "red", "purple", "orange", "green", "black",
                                "pink","darkred","cyan","darkgreen","darkblue","brown")) +
  theme_minimal() +
  theme(legend.position = "bottom")


#############################################################################################################

# Parameter estimation for the different parameters using least squared method

# Define cost function for parameter estimation
cost_function <- function(pars, observed_data) {
  # Create a copy of base_params and update parameters
  params <- base_params
  params["beta_cc"] <- pars[1]
  params["beta_ac"] <- pars[2]
  params["beta_aa"] <- pars[3]
  params["beta_ca"] <- pars[4]
  
  # Simulate the model
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)
  
  # Extract the number of infected individuals (Id)
  simulated_Id <- simulation[, "Id_c"] + simulation[, "Id_a"]
  
  # Calculate the sum of squared errors
  return(sum((observed_data - simulated_Id)^2))
}

# Define lower and upper bounds for the parameters
lower_bounds <- c(beta_cc = 0.1, beta_ac = 0.1 , beta_aa = 0.1,beta_ca=0.1)
upper_bounds <- c(beta_cc = 0.5, beta_ac = 0.5, beta_aa = 1, beta_ca=0.5)

# Initial guesses for the parameters to be estimated
initial_guesses <- c(beta_cc = 0.25, beta_ac = 0.33, beta_aa=0.25*2, beta_ca=0.25)

# Perform parameter estimation using optim with bounds
fit <- optim(par = initial_guesses, fn = cost_function, observed_data = observed_data, 
             method = "L-BFGS-B", lower = lower_bounds, upper = upper_bounds, hessian = TRUE)

# Extract the estimated parameters
estimated <- fit$par
names(estimated) <- c("beta_cc", "beta_ac", "beta_aa","beta_ca")
print(estimated)

# Compute confidence intervals
hessian_matrix <- fit$hessian
cov_matrix <- solve(hessian_matrix)  # Invert the Hessian matrix to get the covariance matrix
std_errors <- sqrt(diag(cov_matrix))  # Standard errors of the parameters
conf_intervals <- cbind(estimated - 1.96 * std_errors, estimated + 1.96 * std_errors)
print(conf_intervals)

# Update the base parameters with the estimated values
params <- base_params
params["beta_cc"] <- estimated["beta_cc"]
params["beta_ac"] <- estimated["beta_ac"]
params["beta_aa"] <- estimated["beta_aa"]
params["beta_ca"] <- estimated["beta_ca"]
#params["rho_I"] <- 2 * estimated["rho_Id"]


# Run the simulation again with estimated parameters
simulation_updated <- ode(y = initial_state, times = times, func = mpox_model, parms = params)

# Plot observed vs predicted
predicted_Id <- simulation_updated[, "Id_c"] + simulation_updated[, "Id_a"]
comparison_df <- data.frame(
  time = times,
  Observed = observed_data,
  Predicted = predicted_Id
)

ggplot(data = comparison_df, aes(x = time)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  labs(title = "Observed vs. Predicted Detected Cases", x = "Time (weeks)", y = "Detected Cases") +
  scale_color_manual("", values = c("Observed" = "red", "Predicted" = "blue")) +
  theme_minimal() +
  theme(legend.position = "bottom")






```



# Parameter Re-estimation


```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.25,     # Transmission rate via child to child
  beta_ac = 0.35,         # Transmission rate via adult to child
  gamma_c = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.15,                # Detection rate
  gamma_c_Id = 0.4555,             # Recovery rate for those who were detected
  rho_c_I = 0.40,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = (0.25 * 2),     # Transmission rate via adult to adult
  beta_ca = 0.25,         # Transmission rate via child to adult 
  gamma_a = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.25,                # Detection rate
  gamma_a_Id = 0.4555,             # Recovery rate for those who were detected
  rho_a_I = 0.25,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.15               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Children population
    dS_c <- -beta_cc * S_c * I_cc / N_c - beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- beta_cc * S_c * I_cc / N_c - gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    dI_ac <- beta_ac * S_c * I_ac / (N_c + N_a) - gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -beta_aa * S_a * I_aa / N_a - beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- beta_aa * S_a * I_aa / N_a - gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    dI_ca <- beta_ca * S_a * I_ca / (N_c + N_a) - gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}

# Run the simulation with the correct model function
simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = base_params)

# Convert the output to a data frame for analysis and plotting
output <- as.data.frame(simulation)

# Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

# Display the output
print(output)

# Plot the results
library(ggplot2)
ggplot(data = output, aes(x = time)) +
  geom_line(aes(y = Susceptible_children, color = "Susceptible_children"), size = 1) +
  geom_line(aes(y = Infectious_children_via_child_child_pathway, 
                color = "Infectious_children_via_child_child_pathway"), size = 1) +
  geom_line(aes(y = Infectious_children_via_adult_child_pathway, 
                color = "Infectious_children_via_adult_child_pathway"), size = 1) +
  geom_line(aes(y = Detected_children, color = "Detected_children"), size = 1) +
  geom_line(aes(y = Recovered_children, color = "Recovered_children"), size = 1) +
  geom_line(aes(y = Dead_children, color = "Dead_children"), size = 1) +
  
  
  geom_line(aes(y = Susceptible_adult, color = "Susceptible_adult"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_adult_adult_pathway, 
                color = "Infectious_adult_via_adult_adult_pathway"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_child_adult_pathway, 
                color = "Infectious_adult_via_child_adult_pathway"), size = 1) +
  geom_line(aes(y = Detected_adult, color = "Detected_adult"), size = 1) +
  geom_line(aes(y = Recovered_adult, color = "Recovered_adult"), size = 1) +
  geom_line(aes(y = Dead_adult, color = "Dead_adult"), size = 1) +
  
  
  labs(title = "SIRD Model Simulation", x = "Time (weeks)", y = "Population") +
  scale_color_manual("", 
                     breaks = c("Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult"),
                     values = c("blue", "red", "purple", "orange", "green", "black",
                                "pink","darkred","cyan","darkgreen","darkblue","brown")) +
  theme_minimal() +
  theme(legend.position = "bottom")


#############################################################################################################

# Parameter estimation for the different parameters using least squared method

# Define cost function for parameter estimation
cost_function <- function(pars, observed_data) {
  # Create a copy of base_params and update parameters
  params <- base_params
  params["beta_cc"] <- pars[1]
  params["beta_ac"] <- pars[2]
  params["beta_aa"] <- pars[3]
  params["beta_ca"] <- pars[4]
  params["gamma_c"] <- pars[5]
  params["gamma_c_Id"] <- pars[6]
  
  # Simulate the model
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)
  
  # Extract the number of infected individuals (Id)
  simulated_Id <- simulation[, "Id_c"] + simulation[, "Id_a"]
  
  # Calculate the sum of squared errors
  return(sum((observed_data - simulated_Id)^2))
}

# Define lower and upper bounds for the parameters
lower_bounds <- c(beta_cc = 0.1, beta_ac = 0.1 , beta_aa = 0.1,beta_ca=0.1,gamma_c=0.1,
                  gamma_c_Id=0.45)

upper_bounds <- c(beta_cc = 1, beta_ac = 1, beta_aa = 1, beta_ca=1,gamma_c=0.5,
                  gamma_c_Id=0.5)

# Initial guesses for the parameters to be estimated
initial_guesses <- c(beta_cc = 0.15, beta_ac = 0.43, beta_aa=0.25*2, beta_ca=0.25,gamma_c=0.15,
                     gamma_c_Id=0.45)

# Perform parameter estimation using optim with bounds
fit <- optim(par = initial_guesses, fn = cost_function, observed_data = observed_data, 
             method = "L-BFGS-B", lower = lower_bounds, upper = upper_bounds, hessian = TRUE)

# Extract the estimated parameters
estimated <- fit$par
names(estimated) <- c("beta_cc", "beta_ac", "beta_aa","beta_ca","gamma_c","gamma_c_Id")
print(estimated)

# Compute confidence intervals
hessian_matrix <- fit$hessian
cov_matrix <- solve(hessian_matrix)  # Invert the Hessian matrix to get the covariance matrix
std_errors <- sqrt(diag(cov_matrix))  # Standard errors of the parameters
conf_intervals <- cbind(estimated - 1.96 * std_errors, estimated + 1.96 * std_errors)
print(conf_intervals)

# Update the base parameters with the estimated values
params <- base_params
params["beta_cc"] <- estimated["beta_cc"]
params["beta_ac"] <- estimated["beta_ac"]
params["beta_aa"] <- estimated["beta_aa"]
params["beta_ca"] <- estimated["beta_ca"]
params["gamma_c"] <- estimated["gamma_c"]
params["gamma_a"] <- estimated["gamma_c"]
params["gamma_c_Id"] <- estimated["gamma_c_Id"]
params["gamma_a_Id"] <- estimated["gamma_c_Id"]

# Run the simulation again with estimated parameters
simulation_updated <- ode(y = initial_state, times = times, func = mpox_model, parms = params)

# Plot observed vs predicted
predicted_Id <- simulation_updated[, "Id_c"] + simulation_updated[, "Id_a"]
comparison_df <- data.frame(
  time = times,
  Observed = observed_data,
  Predicted = predicted_Id
)

ggplot(data = comparison_df, aes(x = time)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  labs(title = "Observed vs. Predicted Detected Cases", x = "Time (weeks)", y = "Detected Cases") +
  scale_color_manual("", values = c("Observed" = "red", "Predicted" = "blue")) +
  theme_minimal() +
  theme(legend.position = "bottom")






```



# Refinning

# Parameter Re-estimation


```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.25,     # Transmission rate via child to child
  beta_ac = 0.35,         # Transmission rate via adult to child
  gamma_c = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.13,                # Detection rate
  gamma_c_Id = 0.4555,             # Recovery rate for those who were detected
  rho_c_I = 0.40,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = (0.25 * 2),     # Transmission rate via adult to adult
  beta_ca = 0.25,         # Transmission rate via child to adult 
  gamma_a = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.15,                # Detection rate
  gamma_a_Id = 0.4555,             # Recovery rate for those who were detected
  rho_a_I = 0.25,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.15               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Children population
    dS_c <- -beta_cc * S_c * I_cc / N_c - beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- beta_cc * S_c * I_cc / N_c - gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    dI_ac <- beta_ac * S_c * I_ac / (N_c + N_a) - gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -beta_aa * S_a * I_aa / N_a - beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- beta_aa * S_a * I_aa / N_a - gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    dI_ca <- beta_ca * S_a * I_ca / (N_c + N_a) - gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}

# Run the simulation with the correct model function
simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = base_params)

# Convert the output to a data frame for analysis and plotting
output <- as.data.frame(simulation)

# Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

# Display the output
print(output)

# Plot the results
library(ggplot2)
ggplot(data = output, aes(x = time)) +
  geom_line(aes(y = Susceptible_children, color = "Susceptible_children"), size = 1) +
  geom_line(aes(y = Infectious_children_via_child_child_pathway, 
                color = "Infectious_children_via_child_child_pathway"), size = 1) +
  geom_line(aes(y = Infectious_children_via_adult_child_pathway, 
                color = "Infectious_children_via_adult_child_pathway"), size = 1) +
  geom_line(aes(y = Detected_children, color = "Detected_children"), size = 1) +
  geom_line(aes(y = Recovered_children, color = "Recovered_children"), size = 1) +
  geom_line(aes(y = Dead_children, color = "Dead_children"), size = 1) +
  
  
  geom_line(aes(y = Susceptible_adult, color = "Susceptible_adult"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_adult_adult_pathway, 
                color = "Infectious_adult_via_adult_adult_pathway"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_child_adult_pathway, 
                color = "Infectious_adult_via_child_adult_pathway"), size = 1) +
  geom_line(aes(y = Detected_adult, color = "Detected_adult"), size = 1) +
  geom_line(aes(y = Recovered_adult, color = "Recovered_adult"), size = 1) +
  geom_line(aes(y = Dead_adult, color = "Dead_adult"), size = 1) +
  
  
  labs(title = "SIRD Model Simulation", x = "Time (weeks)", y = "Population") +
  scale_color_manual("", 
                     breaks = c("Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult"),
                     values = c("blue", "red", "purple", "orange", "green", "black",
                                "pink","darkred","cyan","darkgreen","darkblue","brown")) +
  theme_minimal() +
  theme(legend.position = "bottom")


#############################################################################################################

# Parameter estimation for the different parameters using least squared method

# Define cost function for parameter estimation
cost_function <- function(pars, observed_data) {
  # Create a copy of base_params and update parameters
  params <- base_params
  params["beta_cc"] <- pars[1]
  params["beta_ac"] <- pars[2]
  params["beta_aa"] <- pars[3]
  params["beta_ca"] <- pars[4]
  params["gamma_c"] <- pars[5]
  params["gamma_c_Id"] <- pars[6]
  
  # Simulate the model
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)
  
  # Extract the number of infected individuals (Id)
  simulated_Id <- simulation[, "Id_c"] + simulation[, "Id_a"]
  
  # Calculate the sum of squared errors
  return(sum((observed_data - simulated_Id)^2))
}

# Define lower and upper bounds for the parameters
lower_bounds <- c(beta_cc = 0.1, beta_ac = 0.1 , beta_aa = 0.1,beta_ca=0.1,gamma_c=0.1,
                  gamma_c_Id=0.45)

upper_bounds <- c(beta_cc = 1, beta_ac = 1, beta_aa = 1, beta_ca=1,gamma_c=0.5,
                  gamma_c_Id=0.5)

# Initial guesses for the parameters to be estimated
initial_guesses <- c(beta_cc = 0.15, beta_ac = 0.43, beta_aa=0.25*2, beta_ca=0.25,gamma_c=0.15,
                     gamma_c_Id=0.45)

# Perform parameter estimation using optim with bounds
fit <- optim(par = initial_guesses, fn = cost_function, observed_data = observed_data, 
             method = "L-BFGS-B", lower = lower_bounds, upper = upper_bounds, hessian = TRUE)

# Extract the estimated parameters
estimated <- fit$par
names(estimated) <- c("beta_cc", "beta_ac", "beta_aa","beta_ca","gamma_c","gamma_c_Id")
print(estimated)

# Compute confidence intervals
hessian_matrix <- fit$hessian
cov_matrix <- solve(hessian_matrix)  # Invert the Hessian matrix to get the covariance matrix
std_errors <- sqrt(diag(cov_matrix))  # Standard errors of the parameters
conf_intervals <- cbind(estimated - 1.96 * std_errors, estimated + 1.96 * std_errors)
print(conf_intervals)

# Update the base parameters with the estimated values
params <- base_params
params["beta_cc"] <- estimated["beta_cc"]
params["beta_ac"] <- estimated["beta_ac"]
params["beta_aa"] <- estimated["beta_aa"]
params["beta_ca"] <- estimated["beta_ca"]
params["gamma_c"] <- estimated["gamma_c"]
params["gamma_a"] <- estimated["gamma_c"]
params["gamma_c_Id"] <- estimated["gamma_c_Id"]
params["gamma_a_Id"] <- estimated["gamma_c_Id"]

# Run the simulation again with estimated parameters
simulation_updated <- ode(y = initial_state, times = times, func = mpox_model, parms = params)

# Plot observed vs predicted
predicted_Id <- simulation_updated[, "Id_c"] + simulation_updated[, "Id_a"]
comparison_df <- data.frame(
  time = times,
  Observed = observed_data,
  Predicted = predicted_Id
)

ggplot(data = comparison_df, aes(x = time)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  labs(title = "Observed vs. Predicted Detected Cases", x = "Time (weeks)", y = "Detected Cases") +
  scale_color_manual("", values = c("Observed" = "red", "Predicted" = "blue")) +
  theme_minimal() +
  theme(legend.position = "bottom")






```




# Refinning

# Parameter Re-estimation


```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.25,     # Transmission rate via child to child
  beta_ac = 0.35,         # Transmission rate via adult to child
  gamma_c = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.13,                # Detection rate
  gamma_c_Id = 0.4555,             # Recovery rate for those who were detected
  rho_c_I = 0.40,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = (0.25 * 2),     # Transmission rate via adult to adult
  beta_ca = 0.25,         # Transmission rate via child to adult 
  gamma_a = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.125,                # Detection rate
  gamma_a_Id = 0.4555,             # Recovery rate for those who were detected
  rho_a_I = 0.25,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.15               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Children population
    dS_c <- -beta_cc * S_c * I_cc / N_c - beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- beta_cc * S_c * I_cc / N_c - gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    dI_ac <- beta_ac * S_c * I_ac / (N_c + N_a) - gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -beta_aa * S_a * I_aa / N_a - beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- beta_aa * S_a * I_aa / N_a - gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    dI_ca <- beta_ca * S_a * I_ca / (N_c + N_a) - gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}

# Run the simulation with the correct model function
simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = base_params)

# Convert the output to a data frame for analysis and plotting
output <- as.data.frame(simulation)

# Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

# Display the output
print(output)

# Plot the results
library(ggplot2)
ggplot(data = output, aes(x = time)) +
  geom_line(aes(y = Susceptible_children, color = "Susceptible_children"), size = 1) +
  geom_line(aes(y = Infectious_children_via_child_child_pathway, 
                color = "Infectious_children_via_child_child_pathway"), size = 1) +
  geom_line(aes(y = Infectious_children_via_adult_child_pathway, 
                color = "Infectious_children_via_adult_child_pathway"), size = 1) +
  geom_line(aes(y = Detected_children, color = "Detected_children"), size = 1) +
  geom_line(aes(y = Recovered_children, color = "Recovered_children"), size = 1) +
  geom_line(aes(y = Dead_children, color = "Dead_children"), size = 1) +
  
  
  geom_line(aes(y = Susceptible_adult, color = "Susceptible_adult"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_adult_adult_pathway, 
                color = "Infectious_adult_via_adult_adult_pathway"), size = 1) +
  geom_line(aes(y = Infectious_adult_via_child_adult_pathway, 
                color = "Infectious_adult_via_child_adult_pathway"), size = 1) +
  geom_line(aes(y = Detected_adult, color = "Detected_adult"), size = 1) +
  geom_line(aes(y = Recovered_adult, color = "Recovered_adult"), size = 1) +
  geom_line(aes(y = Dead_adult, color = "Dead_adult"), size = 1) +
  
  
  labs(title = "SIRD Model Simulation", x = "Time (weeks)", y = "Population") +
  scale_color_manual("", 
                     breaks = c("Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult"),
                     values = c("blue", "red", "purple", "orange", "green", "black",
                                "pink","darkred","cyan","darkgreen","darkblue","brown")) +
  theme_minimal() +
  theme(legend.position = "bottom")


#############################################################################################################

# Parameter estimation for the different parameters using least squared method

# Define cost function for parameter estimation
cost_function <- function(pars, observed_data) {
  # Create a copy of base_params and update parameters
  params <- base_params
  params["beta_cc"] <- pars[1]
  params["beta_ac"] <- pars[2]
  params["beta_aa"] <- pars[3]
  params["beta_ca"] <- pars[4]
  params["gamma_c"] <- pars[5]
  params["gamma_c_Id"] <- pars[6]
  params["sigma_c"] <- pars[7]
  
  # Simulate the model
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)
  
  # Extract the number of infected individuals (Id)
  simulated_Id <- simulation[, "Id_c"] + simulation[, "Id_a"]
  
  # Calculate the sum of squared errors
  return(sum((observed_data - simulated_Id)^2))
}

# Define lower and upper bounds for the parameters
lower_bounds <- c(beta_cc = 0.1, beta_ac = 0.1 , beta_aa = 0.1,beta_ca=0.1,gamma_c=0.1,
                  gamma_c_Id=0.45, sigma_c=0.129999)

upper_bounds <- c(beta_cc = 1, beta_ac = 1, beta_aa = 1, beta_ca=1,gamma_c=0.5,
                  gamma_c_Id=0.5, sigma_c=0.1399999)

# Initial guesses for the parameters to be estimated
initial_guesses <- c(beta_cc = 0.15, beta_ac = 0.43, beta_aa=0.25*2, beta_ca=0.25,gamma_c=0.15,
                     gamma_c_Id=0.45, sigma_c=0.13)

# Perform parameter estimation using optim with bounds
fit <- optim(par = initial_guesses, fn = cost_function, observed_data = observed_data, 
             method = "L-BFGS-B", lower = lower_bounds, upper = upper_bounds, hessian = TRUE)

# Extract the estimated parameters
estimated <- fit$par
names(estimated) <- c("beta_cc", "beta_ac", "beta_aa","beta_ca","gamma_c","gamma_c_Id",
                      "sigma_c")
print(estimated)

# Compute confidence intervals
hessian_matrix <- fit$hessian
cov_matrix <- solve(hessian_matrix)  # Invert the Hessian matrix to get the covariance matrix
std_errors <- sqrt(diag(cov_matrix))  # Standard errors of the parameters
conf_intervals <- cbind(estimated - 1.96 * std_errors, estimated + 1.96 * std_errors)
print(conf_intervals)

# Update the base parameters with the estimated values
params <- base_params
params["beta_cc"] <- estimated["beta_cc"]
params["beta_ac"] <- estimated["beta_ac"]
params["beta_aa"] <- estimated["beta_aa"]
params["beta_ca"] <- estimated["beta_ca"]
params["gamma_c"] <- estimated["gamma_c"]
params["gamma_a"] <- estimated["gamma_c"]
params["gamma_c_Id"] <- estimated["gamma_c_Id"]
params["gamma_a_Id"] <- estimated["gamma_c_Id"]
params["sigma_c"] <- estimated["sigma_c"]

# Run the simulation again with estimated parameters
simulation_updated <- ode(y = initial_state, times = times, func = mpox_model, parms = params)

# Plot observed vs predicted
predicted_Id <- simulation_updated[, "Id_c"] + simulation_updated[, "Id_a"]
comparison_df <- data.frame(
  time = times,
  Observed = observed_data,
  Predicted = predicted_Id
)

ggplot(data = comparison_df, aes(x = time)) +
  geom_line(aes(y = Observed, color = "Observed"), size = 1) +
  geom_line(aes(y = Predicted, color = "Predicted"), size = 1, linetype = "dashed") +
  labs(title = "Observed vs. Predicted Detected Cases", x = "Time (weeks)", y = "Detected Cases") +
  scale_color_manual("", values = c("Observed" = "red", "Predicted" = "blue")) +
  theme_minimal() +
  theme(legend.position = "bottom")






```




```{r}
# Simulate again with new parameters
simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)
simulation_df <- as.data.frame(simulation)

simulation_df$Date = cases$Date

# Define start date for the timeline
start_date <- as.Date("2023-08-20")  # Example start date

# Create a date vector for the time points (based on weeks, as the time vector is weekly)
date_vector <- seq.Date(from = start_date, by = "week", length.out = length(times))
project_time <- seq(max(times),max(times)+52*1) # 1 year more (52 Weeks)
projection <- ode(y = initial_state, times = project_time, func = mpox_model, parms = params)
projection_df <- as.data.frame(projection)

# Create a date vector for the projection period
projection_date_vector <- seq.Date(from = max(date_vector), by = "week", length.out = length(project_time))


simulation_df$infections_detected = simulation_df$Id_c + simulation_df$Id_a

# Plot the observed and simulated results with dates on the x-axis
print(
  plot(date_vector, simulation_df$infections_detected, type = "l", col = "red", ylab = "Detected Infected Humans (Id)", xlab = "Date", xaxt = "n")
)
# Overlay observed data (make sure 'observed_data' has the correct length)
# Ensure the lengths of observed data and date vector match
if (length(observed_data) > length(date_vector)) {
  observed_data <- observed_data[1:length(date_vector)]
} else if (length(observed_data) < length(date_vector)) {
  date_vector <- date_vector[1:length(observed_data)]
}

# Plot the simulated detected cases with dates on the x-axis
plot(date_vector, simulation_df$infections_detected, type = "l", col = "red", ylab = "Detected Infected Humans (Id)", xlab = "Date")

# Overlay observed data (ensure 'observed_data' and 'date_vector' have the same length)
points(date_vector, observed_data, col = "blue", pch = 16)

## Add a legend to differentiate between simulated and observed data
#legend("topright", legend = c("Simulated Detected", "Observed Data"), col = c("red", "blue"), #lty = 1, pch = c(NA, 16))

```



```{r}

#points(date_vector, observed_data, col = "blue", pch = 16)

projection_df$infections_detected = projection_df$Id_c + projection_df$Id_a


# Format the x-axis to show dates
axis.Date(1, at = date_vector, format = "%b %Y")  # Custom format: "Month Year"
legend("topleft", legend = c("Simulated Id", "Observed Data"), col = c("red", "blue"), lty = c(1, NA), pch=c(NA,16))

# Plot the projection with dates on the x-axis
print(
  plot(projection_date_vector, projection_df$infections_detected, type = "l", col = "red", ylab = "Projected detected Infected Humans (Id)", xlab = "Date", xaxt = "n")
)
axis.Date(1, at = projection_date_vector, format = "%b %Y")


#projection_df


```




###########################################################################################################


##############################################################################################

# Let's add an intervention e.g contact tracing, Isolation etc

# First run the model with the estimates estimates

```{r}

simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params)

# Convert the output to a data frame for analysis and plotting
output <- as.data.frame(simulation)

# Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

# Calculate total infected
output$Total_Infected <- output$Detected_children + 
                         output$Detected_adult

# Display the output
print(output)

# Plot only the total infected
ggplot(data = output, aes(x = time)) +
  geom_line(aes(y = Total_Infected, color = "Total Infected"), size = 1) +  # Plot Total Infected
  labs(title = "Total Infected Population Over Time", x = "Time (weeks)", y = "Population") +
  scale_color_manual("", 
                     breaks = c("Total Infected"),
                     values = c("brown")) +  # Set color for Total Infected
  theme_minimal() +
  theme(legend.position = "bottom")


```



##############################################################################################
##############################################################################################
##############################################################################################
##############################################################################################
# Interventions

# Now, let's introduce an intervention like contact tracing. Contact tracing reduces the transmission rate by quickly removing infected individuals. Using 
(1−m𝑢)* all the betas, we'll examine mu values of 0, 0.01, 0.04, and 0.08, and plot the total number of infected individuals for each mu.


```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.7702839,     # Transmission rate via child to child
  beta_ac = 0.8268536,         # Transmission rate via adult to child
  gamma_c = 0.1000000,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.1299990,                # Detection rate
  gamma_c_Id = 0.5000000,             # Recovery rate for those who were detected
  rho_c_I = 0.40,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = 0.5563186,     # Transmission rate via adult to adult
  beta_ca = 0.6860959,         # Transmission rate via child to adult 
  gamma_a = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.125,                # Detection rate
  gamma_a_Id = 0.4555,             # Recovery rate for those who were detected
  rho_a_I = 0.25,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.15               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Calculate the modified transmission rates
    mu <- parms["mu"]  # Intervention effectiveness
    effective_beta_cc <- (1 - mu) * beta_cc
    effective_beta_ac <- (1 - mu) * beta_ac
    
    effective_beta_aa <- (1 - mu) * beta_aa
    effective_beta_ca <- (1 - mu) * beta_ca
    
    
    # Children population
    dS_c <- -effective_beta_cc * S_c * I_cc / N_c - 
             effective_beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- effective_beta_cc * S_c * I_cc / N_c - 
             gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    
    dI_ac <- effective_beta_ac * S_c * I_ac / (N_c + N_a) - 
             gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -effective_beta_aa * S_a * I_aa / N_a - 
             effective_beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- effective_beta_aa * S_a * I_aa / N_a - 
             gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    
    dI_ca <- effective_beta_ca * S_a * I_ca / (N_c + N_a) - 
             gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}


# Values for mu to test
mu_values <- c(0,0.01, 0.04, 0.08)

# Prepare an empty list to store simulation results
simulation_results <- list()

# Run simulations for different values of mu
for (mu in mu_values) {
  # Add mu to parameters
  params_with_mu <- c(base_params, mu = mu)
  
  # Run the simulation
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params_with_mu)
  
  # Convert the output to a data frame for analysis and plotting
  output <- as.data.frame(simulation)
  
  # Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

  
  # Calculate total infected
output$Total_Infected <- output$Detected_children + 
                         output$Detected_adult
  
  # Store results with mu as a list entry
  simulation_results[[paste0("mu_", mu)]] <- output
}


# Combine results into one data frame for plotting
combined_results <- do.call(rbind, lapply(names(simulation_results), function(name) {
  data <- simulation_results[[name]]
  data$mu <- name  # Add the mu value as a column
  return(data)
}))


# Plot total infected for each mu value
ggplot(data = combined_results, aes(x = time, y = Total_Infected, color = mu)) +
  geom_line(size = 1) +  # Plot Total Infected for each mu
  labs(title = "Total Infected Population Over Time with Contact Tracing", 
       x = "Time (weeks)", 
       y = "Population") +
  scale_color_manual("",
                     breaks = c("mu_0", "mu_0.01", "mu_0.04", "mu_0.08"),  # Correct breaks for mu
                     labels = c("Contact Tracing (μ = 0)", "Contact Tracing (μ = 0.01)", 
                                "Contact Tracing (μ = 0.04)", "Contact Tracing (μ = 0.08)"),  # Update labels
                     values = c("brown", "orange", "green", "purple")) +  # Set colors for mu values
  theme_minimal() +
  theme(legend.position = "bottom")



```




##############################################################################################
##############################################################################################
##############################################################################################
##############################################################################################
### Let's also examine an intervention like isolation This also reduces the beta values and We'll consider quarantine rates of 0, 0.01, 0.04, and 0.08.



```{r}

# Define base parameters
base_params <- c(
  
  # Children parameters
  beta_cc = 0.7702839,     # Transmission rate via child to child
  beta_ac = 0.8268536,         # Transmission rate via adult to child
  gamma_c = 0.1000000,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.1299990,                # Detection rate
  gamma_c_Id = 0.5000000,             # Recovery rate for those who were detected
  rho_c_I = 0.40,                # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,               # Mortality rate for the infected people that were detected and isolated
  
  
  # Adult parameters
  beta_aa = 0.5563186,     # Transmission rate via adult to adult
  beta_ca = 0.6860959,         # Transmission rate via child to adult 
  gamma_a = 0.25,              # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.125,                # Detection rate
  gamma_a_Id = 0.4555,             # Recovery rate for those who were detected
  rho_a_I = 0.25,                # Mortality rate for the infected people in the community
  rho_a_Id = 0.15               # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,     # Infectious via the sexual route
  I_ac = 20,     # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,         # Dead
  
  
  # adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,     # Infectious via the sexual route
  I_ca = 10,     # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    
    # Calculate the modified transmission rates
    mu <- parms["mu"]  # Intervention effectiveness
    effective_beta_cc <- (1 - mu) * beta_cc
    effective_beta_ac <- (1 - mu) * beta_ac
    
    effective_beta_aa <- (1 - mu) * beta_aa
    effective_beta_ca <- (1 - mu) * beta_ca
    
    
    # Children population
    dS_c <- -effective_beta_cc * S_c * I_cc / N_c - 
             effective_beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- effective_beta_cc * S_c * I_cc / N_c - 
             gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    
    dI_ac <- effective_beta_ac * S_c * I_ac / (N_c + N_a) - 
             gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    
    # Adult population
    dS_a <- -effective_beta_aa * S_a * I_aa / N_a - 
             effective_beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- effective_beta_aa * S_a * I_aa / N_a - 
             gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    
    dI_ca <- effective_beta_ca * S_a * I_ca / (N_c + N_a) - 
             gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}


# Values for mu to test
mu_values <- c(0,0.01, 0.04, 0.08)

# Prepare an empty list to store simulation results
simulation_results <- list()

# Run simulations for different values of mu
for (mu in mu_values) {
  # Add mu to parameters
  params_with_mu <- c(base_params, mu = mu)
  
  # Run the simulation
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params_with_mu)
  
  # Convert the output to a data frame for analysis and plotting
  output <- as.data.frame(simulation)
  
  # Rename columns for clarity
colnames(output) <- c("time", "Susceptible_children", 
                      "Infectious_children_via_child_child_pathway", 
                      "Infectious_children_via_adult_child_pathway",
                      "Detected_children", 
                      "Recovered_children", 
                      "Dead_children",
                      
                      "Susceptible_adult", 
                      "Infectious_adult_via_adult_adult_pathway", 
                      "Infectious_adult_via_child_adult_pathway",
                      "Detected_adult", 
                      "Recovered_adult", 
                      "Dead_adult")

  
  # Calculate total infected
output$Total_Infected <- output$Detected_children + 
                         output$Detected_adult
  
  # Store results with mu as a list entry
  simulation_results[[paste0("mu_", mu)]] <- output
}


# Combine results into one data frame for plotting
combined_results <- do.call(rbind, lapply(names(simulation_results), function(name) {
  data <- simulation_results[[name]]
  data$mu <- name  # Add the mu value as a column
  return(data)
}))


# Plot total infected for each mu value
ggplot(data = combined_results, aes(x = time, y = Total_Infected, color = mu)) +
  geom_line(size = 1) +  # Plot Total Infected for each mu
  labs(title = "Total Infected Population Over Time with isolation", 
       x = "Time (weeks)", 
       y = "Population") +
  scale_color_manual("",
                     breaks = c("mu_0", "mu_0.01", "mu_0.04", "mu_0.08"),  # Correct breaks for mu
                     labels = c("Isolation (μ = 0)", "Isolation (μ = 0.01)", 
                                "Isolation (μ = 0.04)", "Isolation (μ = 0.08)"),  # Update labels
                     values = c("brown", "orange", "green", "purple")) +  # Set colors for mu values
  theme_minimal() +
  theme(legend.position = "bottom")



```



###############################################################################################
##############################################################################################
## Let's now compare contact tracing with a rate of 0.02 on its own and isolation at a rate of 0.04, to the combination of both contact tracing (0.02) and isolation (0.04). Both impact the beta values.



```{r}

# Define base parameters
base_params <- c(
  # Children parameters
  beta_cc = 0.7702839,     # Transmission rate via child to child
  beta_ac = 0.8268536,     # Transmission rate via adult to child
  gamma_c = 0.1000000,     # Recovery rate for those who were infectious and remained in the general population 
  sigma_c = 0.1299990,     # Detection rate
  gamma_c_Id = 0.5000000,  # Recovery rate for those who were detected
  rho_c_I = 0.40,          # Mortality rate for the infected people in the community
  rho_c_Id = 0.35,         # Mortality rate for the infected people that were detected and isolated
  
  # Adult parameters
  beta_aa = 0.5563186,     # Transmission rate via adult to adult
  beta_ca = 0.6860959,     # Transmission rate via child to adult 
  gamma_a = 0.25,          # Recovery rate for those who were infectious and remained in the general population 
  sigma_a = 0.125,         # Detection rate
  gamma_a_Id = 0.4555,     # Recovery rate for those who were detected
  rho_a_I = 0.25,          # Mortality rate for the infected people in the community
  rho_a_Id = 0.15          # Mortality rate for the infected people that were detected and isolated
)

# Define initial state
initial_state <- c(
  # Children population
  S_c = 115e3,    # Susceptible
  I_cc = 5,       # Infectious via the sexual route
  I_ac = 20,      # Infectious via other routes
  Id_c = 8,       # Detected population
  R_c = 0,        # Recovered
  D_c = 0,        # Dead
  
  # Adult population
  S_a = 150e2,    # Susceptible
  I_aa = 15,      # Infectious via the sexual route
  I_ca = 10,      # Infectious via other routes
  Id_a = 8,       # Detected population
  R_a = 0,        # Recovered
  D_a = 0         # Dead
)

# Define the time sequence for 57 weeks
times <- seq(1, 57, by = 1)

# Define the model function
mpox_model <- function(time, state, parms) {
  with(as.list(c(state, parms)), {
    N_c <- S_c + I_cc + I_ac + Id_c + R_c + D_c
    N_a <- S_a + I_aa + I_ca + Id_a + R_a + D_a
    
    # Calculate the modified transmission rates
    contact_tracing <- parms["contact_tracing"]
    quarantine <- parms["quarantine"]
    
    effective_beta_cc <- (1 - contact_tracing) * (1 - quarantine) * beta_cc
    effective_beta_ac <- (1 - contact_tracing) * (1 - quarantine) * beta_ac
    
    effective_beta_aa <- (1 - contact_tracing) * (1 - quarantine) * beta_aa
    effective_beta_ca <- (1 - contact_tracing) * (1 - quarantine) * beta_ca
    
    # Children population
    dS_c <- -effective_beta_cc * S_c * I_cc / N_c - 
             effective_beta_ac * S_c * I_ac / (N_c + N_a)
    dI_cc <- effective_beta_cc * S_c * I_cc / N_c - 
             gamma_c * I_cc - sigma_c * I_cc - rho_c_I * I_cc
    
    dI_ac <- effective_beta_ac * S_c * I_ac / (N_c + N_a) - 
             gamma_c * I_ac - sigma_c * I_ac - rho_c_I * I_ac
    
    dId_c <- sigma_c * (I_cc + I_ac) - gamma_c_Id * Id_c - rho_c_Id * Id_c
    dR_c <- gamma_c * (I_cc + I_ac) + gamma_c_Id * Id_c
    dD_c <- rho_c_I * (I_cc + I_ac) + rho_c_Id * Id_c
    
    # Adult population
    dS_a <- -effective_beta_aa * S_a * I_aa / N_a - 
             effective_beta_ca * S_a * I_ca / (N_c + N_a)
    dI_aa <- effective_beta_aa * S_a * I_aa / N_a - 
             gamma_a * I_aa - sigma_a * I_aa - rho_a_I * I_aa
    
    dI_ca <- effective_beta_ca * S_a * I_ca / (N_c + N_a) - 
             gamma_a * I_ca - sigma_a * I_ca - rho_a_I * I_ca
    
    dId_a <- sigma_a * (I_aa + I_ca) - gamma_a_Id * Id_a - rho_a_Id * Id_a
    dR_a <- gamma_a * (I_aa + I_ca) + gamma_a_Id * Id_a
    dD_a <- rho_a_I * (I_aa + I_ca) + rho_a_Id * Id_a
    
    return(list(c(dS_c, dI_cc, dI_ac, dId_c, dR_c, dD_c,
                  dS_a, dI_aa, dI_ca, dId_a, dR_a, dD_a)))
  })
}

# Values for interventions to test
intervention_values <- c(0.02, 0.02, 0.04)  # Contact tracing and quarantine rates of 0.02

# Prepare an empty list to store simulation results
simulation_results <- list()

# Run simulations for different scenarios: no intervention, contact tracing only, quarantine only, and both combined
scenarios <- list(
  "No_Intervention" = c(contact_tracing = 0, quarantine = 0),
  "Contact_Tracing_0.02" = c(contact_tracing = 0.02, quarantine = 0),
  "Quarantine_0.04" = c(contact_tracing = 0, quarantine = 0.04),
  "Both_Combined_0.02_and_0.04" = c(contact_tracing = 0.02, quarantine = 0.04)
)

for (scenario in names(scenarios)) {
  # Add the intervention values to parameters
  params_with_intervention <- c(base_params, scenarios[[scenario]])
  
  # Run the simulation
  simulation <- ode(y = initial_state, times = times, func = mpox_model, parms = params_with_intervention)
  
  # Convert the output to a data frame for analysis and plotting
  output <- as.data.frame(simulation)
  
  # Rename columns for clarity
  colnames(output) <- c("time", "Susceptible_children", 
                         "Infectious_children_via_child_child_pathway", 
                         "Infectious_children_via_adult_child_pathway",
                         "Detected_children", 
                         "Recovered_children", 
                         "Dead_children",
                         "Susceptible_adult", 
                         "Infectious_adult_via_adult_adult_pathway", 
                         "Infectious_adult_via_child_adult_pathway",
                         "Detected_adult", 
                         "Recovered_adult", 
                         "Dead_adult")
  
  # Calculate total infected
  output$Total_Infected <- output$Detected_children + output$Detected_adult
  
  # Store results with the scenario name as a list entry
  simulation_results[[scenario]] <- output
}

# Combine results into one data frame for plotting
combined_results <- do.call(rbind, lapply(names(simulation_results), function(name) {
  data <- simulation_results[[name]]
  data$scenario <- name  # Add the scenario name as a column
  return(data)
}))

# Load ggplot2 for plotting
library(ggplot2)

# Plot total infected for each scenario
ggplot(data = combined_results, aes(x = time, y = Total_Infected, color = scenario)) +
  geom_line(size = 1) +  # Plot Total Infected for each scenario
  labs(title = "Total Infected Population Over Time with Various Interventions", 
       x = "Time (weeks)", 
       y = "Population") +
  scale_color_manual("",
                     breaks = c("No_Intervention", "Contact_Tracing_0.02", "Quarantine_0.04", "Both_Combined_0.02_and_0.04"),  
                     labels = c("No Intervention (μ = 0)", 
                                "Contact Tracing (μ = 0.02)", 
                                "Quarantine (μ = 0.04)", 
                                "Both Combined (μ = 0.02 and μ = 0.04)"),  
                     values = c("black", "blue", "red", "purple")) +  # Set colors for scenarios
  theme_minimal() +
  theme(legend.position = "bottom")




```
























